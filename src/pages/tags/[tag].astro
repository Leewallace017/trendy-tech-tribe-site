---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import PostCard from '../../components/PostCard.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const allPosts = [
    ...await getCollection('tech'),
    ...await getCollection('ai'),
    ...await getCollection('evs'),
    ...await getCollection('energy'),
    ...await getCollection('markets'),
    ...await getCollection('picks'),
  ];

  const uniqueTags = [...new Set(allPosts.map((post) => post.data.tags).flat())];

  return uniqueTags.map((tag) => {
    const filteredPosts = allPosts.filter((post) => 
      post.data.tags.includes(tag)
    ).sort((a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime());

    return {
      params: { tag: tag.toLowerCase().replace(/\s+/g, '-') },
      props: { tag, posts: filteredPosts },
    };
  });
}

const { tag, posts } = Astro.props;

const categoryMap: Record<string, string> = {
  'Tech & Innovation': 'tech',
  'AI & Automation': 'ai',
  'EVs & Mobility': 'evs',
  'Energy & Policy': 'energy',
  'Markets & Money': 'markets',
  'Picks & Reviews': 'picks',
};
---

<BaseLayout
  title={`${tag} - Trendy Tech Tribe`}
  description={`Read all articles about ${tag} on Trendy Tech Tribe.`}
>
  <Header />

  <main class="container">
    <header class="tag-header">
      <span class="tag-label">Topic</span>
      <h1 class="tag-title">#{tag}</h1>
      <p class="tag-count">{posts.length} {posts.length === 1 ? 'article' : 'articles'}</p>
    </header>

    <div class="posts-grid">
      {posts.map((post) => (
        <PostCard 
          post={post} 
          categorySlug={categoryMap[post.data.category] || 'tech'} 
        />
      ))}
    </div>
  </main>

  <Footer />
</BaseLayout>

<style>
  .tag-header {
    text-align: center;
    padding: var(--space-2xl) 0;
    margin-bottom: var(--space-xl);
    background: radial-gradient(circle at center, rgba(123, 31, 162, 0.15) 0%, transparent 70%);
  }

  .tag-label {
    display: inline-block;
    font-size: var(--text-body-sm);
    text-transform: uppercase;
    letter-spacing: var(--tracking-widest);
    color: var(--neon-cyan);
    margin-bottom: var(--space-4);
    font-weight: var(--weight-bold);
  }

  .tag-title {
    font-family: var(--font-display);
    font-size: var(--text-display);
    font-weight: var(--weight-black);
    margin-bottom: var(--space-4);
    background: var(--gradient-text-neon);
    background-clip: text;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    text-transform: capitalize;
  }

  .tag-count {
    font-size: var(--text-body-lg);
    color: var(--text-secondary);
  }

  .posts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: var(--space-8);
    margin-bottom: var(--space-24);
  }

  @media (max-width: 768px) {
    .tag-title {
      font-size: 2.5rem;
    }

    .posts-grid {
      grid-template-columns: 1fr;
      gap: var(--space-6);
    }
  }
</style>
